<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿µå¥´å¬ŒÂ·èµ¤å£æ‡·å¤ | é«˜ä¸­äº’å‹•æ•™å­¸èª²ä»¶</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Noto Serif TC (for poem feel) & Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfbf7; /* Rice paper color */
            color: #2c2c2c;
        }
        .font-serif-tc {
            font-family: 'Noto Serif TC', serif;
        }
        .ink-brush-bg {
            background-image: url('https://images.unsplash.com/photo-1517488989505-df43b006c35e?q=80&w=2070&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
        }
        .ink-overlay {
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(253, 251, 247, 1));
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Gemini API Configuration ---
        const apiKey = ""; // The execution environment provides the key at runtime.
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

        async function callGemini(prompt, systemInstruction = "", isJson = false) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined,
                generationConfig: isJson ? { responseMimeType: "application/json" } : undefined
            };

            // Exponential backoff retry logic
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) throw new Error("No text generated");
                    
                    return isJson ? JSON.parse(text) : text;

                } catch (error) {
                    if (i === delays.length) throw error;
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        }

        // --- Icons ---
        const Icons = {
            BookOpen: () => <i data-lucide="book-open"></i>,
            Feather: () => <i data-lucide="feather"></i>,
            MapPin: () => <i data-lucide="map-pin"></i>,
            Brain: () => <i data-lucide="brain"></i>,
            ListChecks: () => <i data-lucide="list-checks"></i>,
            HelpCircle: () => <i data-lucide="help-circle"></i>,
            ChevronRight: () => <i data-lucide="chevron-right"></i>,
            Scroll: () => <i data-lucide="scroll"></i>,
            User: () => <i data-lucide="user"></i>,
            Sparkles: () => <i data-lucide="sparkles"></i>,
            Send: () => <i data-lucide="send"></i>,
            Bot: () => <i data-lucide="bot"></i>,
            RefreshCw: () => <i data-lucide="refresh-cw"></i>,
        };

        // --- Data Content ---
        const lessonData = {
            title: "å¿µå¥´å¬ŒÂ·èµ¤å£æ‡·å¤",
            author: "è˜‡è»¾",
            poem: [
                "å¤§æ±Ÿæ±å»ï¼Œæµªæ·˜ç›¡ã€åƒå¤é¢¨æµäººç‰©ã€‚",
                "æ•…å£˜è¥¿é‚Šï¼Œäººé“æ˜¯ã€ä¸‰åœ‹å‘¨éƒèµ¤å£ã€‚",
                "äº‚çŸ³ç©¿ç©ºï¼Œé©šæ¿¤æ‹å²¸ï¼Œæ²èµ·åƒå †é›ªã€‚",
                "æ±Ÿå±±å¦‚ç•«ï¼Œä¸€æ™‚å¤šå°‘è±ªå‚‘ã€‚",
                "é™æƒ³å…¬ç‘¾ç•¶å¹´ï¼Œå°å–¬åˆå«äº†ï¼Œé›„å§¿è‹±ç™¼ã€‚",
                "ç¾½æ‰‡ç¶¸å·¾ï¼Œè«‡ç¬‘é–“ã€å¼·è™œç°é£›ç…™æ»…ã€‚",
                "æ•…åœ‹ç¥éŠï¼Œå¤šæƒ…æ‡‰ç¬‘æˆ‘ï¼Œæ—©ç”Ÿè¯é«®ã€‚",
                "äººç”Ÿå¦‚å¤¢ï¼Œä¸€å°Šé‚„é…¹æ±Ÿæœˆã€‚"
            ],
            translation: [
                "é•·æ±Ÿæ»¾æ»¾å‘æ±æµå»ï¼Œæ³¢æµªæ´—æ·¨äº†åƒå¤ä»¥ä¾†çš„é¢¨æµäººç‰©ã€‚",
                "é‚£èˆŠç‡Ÿå£˜çš„è¥¿é‚Šï¼Œäººå€‘èªªæ˜¯ä¸‰åœ‹æ™‚å‘¨ç‘œå¤§æ•—æ›¹è»çš„èµ¤å£ã€‚",
                "é™¡å³­ä¸å¹³çš„çŸ³å£æ’å…¥é«˜ç©ºï¼Œé©šäººçš„å·¨æµªæ‹æ‰“è‘—æ±Ÿå²¸ï¼Œæ²èµ·åƒå †é›ªç™½çš„æµªèŠ±ã€‚",
                "æ±Ÿå±±ç¾å¾—åƒä¸€å¹…ç•«ï¼Œç•¶æ™‚é€™è£¡æ›¾æœ‰å¤šå°‘è‹±é›„è±ªå‚‘ï¼",
                "é™æƒ³ç•¶å¹´çš„å‘¨ç‘œï¼Œå°å–¬å‰›å‰›å«çµ¦ä»–ï¼Œä»–å§¿æ…‹é›„å‰ï¼Œè‹±æ°£å‹ƒç™¼ã€‚",
                "æ‰‹æ–ç¾½æ‰‡ï¼Œé ­æˆ´ç¶¸å·¾ï¼Œåœ¨è«‡ç¬‘ä¹‹é–“ï¼Œå¼·å¤§çš„æ•µè»ï¼ˆæ›¹è»ï¼‰å°±ç°é£›ç…™æ»…äº†ã€‚",
                "ç¥éŠæ–¼ä¸‰åœ‹æˆ°å ´ï¼Œï¼ˆé†’ä¾†å¾Œï¼‰ä¸ç¦å˜²ç¬‘è‡ªå·±å¤ªå¤šæƒ…å–„æ„Ÿï¼Œä»¥è‡´éæ—©é•·å‡ºäº†ç™½é«®ã€‚",
                "äººç”Ÿå°±åƒä¸€å ´å¤¢ï¼Œä¸”ç‘ä¸€æ¯é…’ç¥­å¥ æ±Ÿä¸Šçš„æ˜æœˆå§ã€‚"
            ],
            background: {
                time: "å®‹ç¥å®—å…ƒè±äº”å¹´ï¼ˆ1082å¹´ï¼‰ï¼Œè˜‡è»¾47æ­²ã€‚",
                location: "é»ƒå·ï¼ˆä»Šæ¹–åŒ—é»ƒå²¡ï¼‰èµ¤å£ï¼ˆæ–‡èµ¤å£ï¼Œéä¸‰åœ‹å¤æˆ°å ´ï¼‰ã€‚",
                context: "è˜‡è»¾å› ã€Œçƒè‡ºè©©æ¡ˆã€è¢«è²¶é»ƒå·åœ˜ç·´å‰¯ä½¿ï¼Œæ”¿æ²»å¤±æ„ï¼Œç”Ÿæ´»å›°é “ã€‚ä»–éŠè¦½é»ƒå·èµ¤å£ï¼Œé¢å°å£¯éº—æ™¯è‰²ï¼Œè¯æƒ³åˆ°ä¸‰åœ‹è‹±é›„ï¼Œä»¥æ­¤è©æŠ’ç™¼æƒ…æ‡·ã€‚"
            },
            analysis: {
                theme: "è—‰è© å˜†èµ¤å£çš„å£¯éº—æ™¯è‰²å’Œæ‡·å¿µä¸‰åœ‹è‹±é›„å‘¨ç‘œï¼ŒæŠ’ç™¼è‡ªå·±å¹´è¯è€å»ã€åŠŸæ¥­æœªæˆçš„æ„Ÿæ…¨ï¼Œæœ€çµ‚ä»¥ã€Œäººç”Ÿå¦‚å¤¢ã€çš„æ› é”æ…‹åº¦è‡ªæˆ‘è§£è„«ã€‚",
                deepMeaning: [
                    { title: "è‹±é›„èˆ‡å‡¡äºº", desc: "ä»¥å‘¨ç‘œçš„å¹´å°‘æœ‰ç‚ºï¼ˆé›„å§¿è‹±ç™¼ï¼‰å°æ¯”è‡ªå·±çš„æ—©ç”Ÿè¯é«®ã€ä¸€äº‹ç„¡æˆã€‚" },
                    { title: "æ°¸æ†èˆ‡çŸ­æš«", desc: "ä»¥ã€Œæ±Ÿæœˆã€ã€ã€Œæ±Ÿå±±ã€çš„æ°¸æ†ï¼Œå°æ¯”ã€Œäººç”Ÿã€ã€ã€Œé¢¨æµäººç‰©ã€çš„çŸ­æš«ã€‚" },
                    { title: "å‡ºä¸–èˆ‡å…¥ä¸–", desc: "å¾æ¸´æœ›å»ºåŠŸç«‹æ¥­ï¼ˆå…¥ä¸–ï¼‰è½‰ç‚ºæ¥å—äººç”Ÿå¦‚å¤¢ï¼ˆå‡ºä¸–/é“å®¶æ€æƒ³ï¼‰ï¼Œè¡¨ç¾è˜‡è»¾è±é”çš„äººç”Ÿè§€ã€‚" }
                ],
                techniques: [
                    { title: "å€Ÿå¤æŠ’æ‡·", desc: "å€Ÿä¸‰åœ‹å‘¨ç‘œçš„åŠŸæ¥­ï¼ŒæŠ’ç™¼è‡ªå·±è¢«è²¶è¬«çš„ç„¡å¥ˆèˆ‡æ„Ÿæ…¨ã€‚" },
                    { title: "è¥¯æ‰˜æ‰‹æ³•", desc: "ä»¥èµ¤å£çš„éšªè¦æ™¯è‰²è¥¯æ‰˜è‹±é›„æ°£æ¦‚ï¼›ä»¥å‘¨ç‘œçš„ã€Œé›„å§¿è‹±ç™¼ã€åè¥¯è‡ªå·±çš„ã€Œæ—©ç”Ÿè¯é«®ã€ã€‚" },
                    { title: "è¦–è½çµåˆ", desc: "è¦–è¦ºï¼šäº‚çŸ³ç©¿ç©ºï¼Œæ²èµ·åƒå †é›ªï¼›è½è¦ºï¼šé©šæ¿¤æ‹å²¸ï¼ˆæš—ç¤ºè²éŸ¿ï¼‰ã€‚" },
                    { title: "æ¯”å–»", desc: "ã€Œæ²èµ·åƒå †é›ªã€ï¼ˆä»¥é›ªå–»æµªï¼‰ã€ã€Œäººç”Ÿå¦‚å¤¢ã€ï¼ˆä»¥å¤¢å–»äººç”Ÿï¼‰ã€‚" }
                ]
            },
            quiz: [
                {
                    question: "è©ä¸­ã€Œç¾½æ‰‡ç¶¸å·¾ã€æ˜¯ç”¨ä¾†å½¢å®¹èª°çš„è£æŸï¼Ÿ",
                    options: ["è«¸è‘›äº®", "å‘¨ç‘œ", "æ›¹æ“", "è˜‡è»¾"],
                    answer: 1 // Index of correct answer
                },
                {
                    question: "ã€Œäº‚çŸ³ç©¿ç©ºï¼Œé©šæ¿¤æ‹å²¸ï¼Œæ²èµ·åƒå †é›ªã€ä¸»è¦æå¯«ä»€éº¼ï¼Ÿ",
                    options: ["å‘¨ç‘œçš„è»éšŠ", "æˆ°å ´çš„å»æ®º", "èµ¤å£çš„æ™¯è‰²", "ä½œè€…çš„å¿ƒæƒ…"],
                    answer: 2
                },
                {
                    question: "ä½œè€…ç‚ºä»€éº¼è¦å¯«ã€Œå°å–¬åˆå«äº†ã€ï¼Ÿ",
                    options: ["ç¾¨æ…•å‘¨ç‘œæœ‰ç¾äººç›¸ä¼´", "å´é¢è¥¯æ‰˜å‘¨ç‘œå¹´è¼•å¾—æ„ï¼Œè‹±é›„é…ç¾äºº", "èªªæ˜èµ¤å£ä¹‹æˆ°çš„åŸå› ", "æ„Ÿå˜†è‡ªå·±å­¤ç¨"],
                    answer: 1
                },
                {
                    question: "æœ€å¾Œã€Œä¸€å°Šé‚„é…¹æ±Ÿæœˆã€è¡¨é”äº†ä½œè€…æ€æ¨£çš„æ…‹åº¦ï¼Ÿ",
                    options: ["æ¶ˆæ¥µé¿ä¸–", "å€Ÿé…’æ¶ˆæ„", "æ› é”è§£è„«", "æ†¤ä¸–å«‰ä¿—"],
                    answer: 2
                }
            ]
        };

        // --- Components ---

        const TabButton = ({ active, onClick, icon, label, isSpecial }) => (
            <button 
                onClick={onClick}
                className={`flex items-center space-x-2 px-4 py-3 rounded-lg transition-all duration-300 w-full md:w-auto justify-center md:justify-start
                ${active 
                    ? (isSpecial ? 'bg-gradient-to-r from-violet-600 to-indigo-600 text-white shadow-lg' : 'bg-slate-800 text-white shadow-lg') 
                    : (isSpecial ? 'bg-white text-indigo-600 border border-indigo-100 hover:bg-indigo-50' : 'bg-white text-slate-600 hover:bg-slate-100')}`}
            >
                {icon}
                <span className="font-medium">{label}</span>
            </button>
        );

        const PoemSection = () => {
            const [showTranslation, setShowTranslation] = useState(false);

            return (
                <div className="bg-white p-6 md:p-10 rounded-xl shadow-sm border border-slate-100">
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 className="text-2xl font-bold font-serif-tc text-slate-800">åŸæ–‡èˆ‡èªè­¯</h2>
                        <button 
                            onClick={() => setShowTranslation(!showTranslation)}
                            className="text-sm bg-slate-100 text-slate-600 px-3 py-1 rounded-full hover:bg-slate-200 transition"
                        >
                            {showTranslation ? 'éš±è—èªè­¯' : 'é¡¯ç¤ºèªè­¯'}
                        </button>
                    </div>
                    
                    <div className="space-y-6">
                        {lessonData.poem.map((line, index) => (
                            <div key={index} className="group">
                                <p className="text-xl md:text-2xl font-serif-tc leading-loose text-slate-900 border-l-4 border-transparent group-hover:border-red-800 pl-4 transition-all">
                                    {line}
                                </p>
                                <div className={`overflow-hidden transition-all duration-500 ease-in-out ${showTranslation ? 'max-h-20 opacity-100 mt-2' : 'max-h-0 opacity-0'}`}>
                                    <p className="text-slate-500 pl-5 text-sm md:text-base italic">
                                        {lessonData.translation[index]}
                                    </p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const BackgroundSection = () => (
            <div className="grid md:grid-cols-2 gap-6">
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <div className="flex items-center space-x-2 mb-4 text-red-800">
                        <Icons.MapPin />
                        <h3 className="text-xl font-bold">å¯«ä½œèƒŒæ™¯</h3>
                    </div>
                    <ul className="space-y-4">
                        <li className="flex items-start">
                            <span className="font-bold mr-2 text-slate-400">æ™‚ç©ºï¼š</span>
                            <span>{lessonData.background.time} æ–¼ {lessonData.background.location}</span>
                        </li>
                        <li className="flex items-start">
                            <span className="font-bold mr-2 text-slate-400">ç·£èµ·ï¼š</span>
                            <span className="leading-relaxed">{lessonData.background.context}</span>
                        </li>
                    </ul>
                    <div className="mt-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <h4 className="font-bold text-slate-700 mb-2">ğŸ’¡ é—œéµæ¦‚å¿µï¼šçƒè‡ºè©©æ¡ˆ</h4>
                        <p className="text-sm text-slate-600">
                            è˜‡è»¾å› åå°ç‹å®‰çŸ³è®Šæ³•ï¼Œè¢«æŒ‡è«·åˆºæœæ”¿å…¥ç„ï¼Œéšªé­æ®ºé ­ã€‚æ­»è£¡é€ƒç”Ÿå¾Œè¢«è²¶é»ƒå·ï¼Œé€™æ˜¯ä»–äººç”Ÿè§€è½‰è®Šçš„é‡è¦æ™‚æœŸï¼Œä½œå“é¢¨æ ¼è½‰ç‚ºè±ªæ”¾æ› é”ã€‚
                        </p>
                    </div>
                </div>
                <div className="h-64 md:h-auto rounded-xl overflow-hidden relative shadow-lg">
                    <img 
                        src="https://images.unsplash.com/photo-1542614392-49195a646c24?q=80&w=2072&auto=format&fit=crop" 
                        alt="Red Cliff Atmosphere" 
                        className="w-full h-full object-cover transform hover:scale-105 transition duration-700"
                    />
                    <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-6">
                        <p className="text-white font-serif-tc text-lg">ã€Œäº‚çŸ³ç©¿ç©ºï¼Œé©šæ¿¤æ‹å²¸ã€</p>
                    </div>
                </div>
            </div>
        );

        const AnalysisSection = () => (
            <div className="space-y-8">
                {/* ä¸»æ—¨ */}
                <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-slate-800">
                    <h3 className="text-xl font-bold mb-3 flex items-center">
                        <Icons.Brain className="mr-2 w-5 h-5"/> ä¸»æ—¨
                    </h3>
                    <p className="text-lg leading-relaxed text-slate-700">{lessonData.analysis.theme}</p>
                </div>

                {/* æ·±å±¤æ„ç¾© Cards */}
                <div>
                    <h3 className="text-xl font-bold mb-4 text-slate-800 pl-2 border-l-4 border-red-700">æ·±å±¤æ„ç¾©</h3>
                    <div className="grid md:grid-cols-3 gap-4">
                        {lessonData.analysis.deepMeaning.map((item, idx) => (
                            <div key={idx} className="bg-white p-5 rounded-lg shadow-sm hover:shadow-md transition border border-slate-100">
                                <h4 className="font-bold text-red-800 mb-2">{item.title}</h4>
                                <p className="text-sm text-slate-600">{item.desc}</p>
                            </div>
                        ))}
                    </div>
                </div>

                {/* å¯«ä½œæ‰‹æ³• */}
                <div>
                    <h3 className="text-xl font-bold mb-4 text-slate-800 pl-2 border-l-4 border-red-700">å¯«ä½œæ‰‹æ³•èˆ‡ä¿®è¾­</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                        {lessonData.analysis.techniques.map((tech, idx) => (
                            <div key={idx} className="flex bg-slate-50 p-4 rounded-lg">
                                <div className="mr-4 text-slate-400">
                                    <Icons.Feather />
                                </div>
                                <div>
                                    <h4 className="font-bold text-slate-800">{tech.title}</h4>
                                    <p className="text-sm text-slate-600 mt-1">{tech.desc}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const RevisionSection = () => (
            <div className="space-y-6">
                 <div className="bg-amber-50 border border-amber-200 p-6 rounded-xl">
                    <h3 className="text-xl font-bold text-amber-900 mb-4 flex items-center">
                        <Icons.ListChecks className="mr-2"/> å¿…èƒŒé‡‘å¥èˆ‡è§£æ
                    </h3>
                    <div className="space-y-4">
                        <div className="bg-white p-4 rounded shadow-sm">
                            <p className="font-serif-tc text-lg font-bold text-slate-800 mb-2">å¤§æ±Ÿæ±å»ï¼Œæµªæ·˜ç›¡ã€åƒå¤é¢¨æµäººç‰©ã€‚</p>
                            <span className="text-xs font-bold text-red-600 border border-red-200 px-2 py-0.5 rounded">é–‹ç¯‡æ°£å‹¢</span>
                            <p className="text-sm text-slate-600 mt-1">ä»¥æ™‚é–“å’Œç©ºé–“çš„å»£é—Šé–‹ç¯‡ï¼Œå¥ å®šè±ªæ”¾åŸºèª¿ã€‚æ±Ÿæ°´ç„¡æƒ…ï¼Œå¸¶èµ°ä¸€åˆ‡è‹±é›„ã€‚</p>
                        </div>
                        <div className="bg-white p-4 rounded shadow-sm">
                            <p className="font-serif-tc text-lg font-bold text-slate-800 mb-2">äººç”Ÿå¦‚å¤¢ï¼Œä¸€å°Šé‚„é…¹æ±Ÿæœˆã€‚</p>
                            <span className="text-xs font-bold text-blue-600 border border-blue-200 px-2 py-0.5 rounded">æƒ…æ„Ÿæ˜‡è¯</span>
                            <p className="text-sm text-slate-600 mt-1">é»æ˜ä¸»æ—¨ã€‚æ—¢ç„¶äººç”ŸçŸ­æš«å¦‚å¤¢ï¼Œä¸å¦‚æ”¾ä¸‹åŸ·è‘—ï¼Œèˆ‡æ°¸æ†çš„è‡ªç„¶ï¼ˆæ±Ÿæœˆï¼‰å…±å­˜ã€‚</p>
                        </div>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 className="text-xl font-bold text-slate-800 mb-4">è©çœ¼åˆ†æï¼š ã€Œç¬‘ã€</h3>
                    <div className="flex items-start">
                        <div className="bg-slate-800 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 shrink-0">ç¬‘</div>
                        <div>
                            <p className="font-bold text-lg">ã€Œå¤šæƒ…æ‡‰ç¬‘æˆ‘ã€</p>
                            <p className="text-slate-600 mt-2">
                                é€™è£¡çš„ã€Œç¬‘ã€æ˜¯è‡ªå˜²ã€‚è˜‡è»¾å˜²ç¬‘è‡ªå·±é›–ç„¶å·²ç¶“å¹´è€ï¼ˆæ—©ç”Ÿè¯é«®ï¼‰ï¼Œå»ä¾ç„¶åƒå¹´è¼•äººä¸€æ¨£ã€Œå¤šæƒ…ã€ï¼ˆæ­¤è™•æŒ‡å°åŠŸåäº‹æ¥­çš„åŸ·è‘—ã€å°æ­·å²èˆˆäº¡çš„æ„Ÿå‚·ï¼‰ã€‚é€™ç¨®è‡ªå˜²å…¶å¯¦æ˜¯ä¸€ç¨®ç„¡å¥ˆçš„é‡‹æ‡·ï¼Œä¹Ÿæ˜¯é€šå¾€æœ€çµ‚ã€Œäººç”Ÿå¦‚å¤¢ã€æ› é”å¢ƒç•Œçš„éæ¸¡ã€‚
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        );

        const QuizSection = () => {
            const [currentQ, setCurrentQ] = useState(0);
            const [score, setScore] = useState(0);
            const [showScore, setShowScore] = useState(false);
            const [selectedOption, setSelectedOption] = useState(null);
            const [isCorrect, setIsCorrect] = useState(null);

            const handleAnswer = (optionIndex) => {
                setSelectedOption(optionIndex);
                const correct = optionIndex === lessonData.quiz[currentQ].answer;
                setIsCorrect(correct);
                if (correct) setScore(score + 1);

                setTimeout(() => {
                    const nextQ = currentQ + 1;
                    if (nextQ < lessonData.quiz.length) {
                        setCurrentQ(nextQ);
                        setSelectedOption(null);
                        setIsCorrect(null);
                    } else {
                        setShowScore(true);
                    }
                }, 1500);
            };

            const resetQuiz = () => {
                setCurrentQ(0);
                setScore(0);
                setShowScore(false);
                setSelectedOption(null);
                setIsCorrect(null);
            };

            if (showScore) {
                return (
                    <div className="bg-white p-10 rounded-xl shadow-lg text-center max-w-md mx-auto mt-10">
                        <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">
                            ğŸ†
                        </div>
                        <h3 className="text-2xl font-bold text-slate-800 mb-2">æ¸¬é©—å®Œæˆï¼</h3>
                        <p className="text-slate-600 mb-6">ä½ ç­”å°äº† {score} / {lessonData.quiz.length} é¡Œ</p>
                        <button 
                            onClick={resetQuiz}
                            className="bg-slate-800 text-white px-6 py-2 rounded hover:bg-slate-700 transition"
                        >
                            é‡æ–°æ¸¬é©—
                        </button>
                    </div>
                );
            }

            return (
                <div className="max-w-2xl mx-auto mt-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg border-t-4 border-red-800">
                        <div className="flex justify-between items-center mb-6">
                            <span className="text-sm font-bold text-slate-400">å•é¡Œ {currentQ + 1} / {lessonData.quiz.length}</span>
                            <span className="text-sm bg-slate-100 px-2 py-1 rounded">å¾—åˆ†: {score}</span>
                        </div>
                        <h3 className="text-xl font-bold text-slate-800 mb-8 leading-relaxed">
                            {lessonData.quiz[currentQ].question}
                        </h3>
                        <div className="space-y-3">
                            {lessonData.quiz[currentQ].options.map((option, index) => (
                                <button
                                    key={index}
                                    onClick={() => handleAnswer(index)}
                                    disabled={selectedOption !== null}
                                    className={`w-full text-left p-4 rounded-lg border transition-all duration-200 flex justify-between items-center
                                        ${selectedOption === index 
                                            ? (index === lessonData.quiz[currentQ].answer 
                                                ? 'bg-green-50 border-green-500 text-green-800' 
                                                : 'bg-red-50 border-red-500 text-red-800')
                                            : 'border-slate-200 hover:bg-slate-50 hover:border-slate-300'
                                        }
                                    `}
                                >
                                    <span>{option}</span>
                                    {selectedOption === index && (
                                        <span>
                                            {index === lessonData.quiz[currentQ].answer ? 'âœ…' : 'âŒ'}
                                        </span>
                                    )}
                                </button>
                            ))}
                        </div>
                        {selectedOption !== null && (
                            <div className="mt-4 text-center text-sm text-slate-500 animate-pulse">
                                {isCorrect ? "ç­”å°äº†ï¼ä¸‹ä¸€é¡Œ..." : "ç­”éŒ¯äº†ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š" + lessonData.quiz[currentQ].options[lessonData.quiz[currentQ].answer]}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const AITutorSection = () => {
            const [mode, setMode] = useState('chat'); // 'chat' or 'quiz'
            
            // Chat State
            const [messages, setMessages] = useState([
                { role: 'ai', text: 'å¾ä¹ƒè˜‡å­ç»ã€‚ä»Šæ—¥èˆ‡å°å‹ç›¸é€¢æ–¼èµ¤å£ï¼Œå¹¸ç”šï¼ä½ å°æˆ‘é€™é¦–ã€Šå¿µå¥´å¬Œã€‹æœ‰ä½•ç–‘å•ï¼Œæˆ–æƒ³è½è½æˆ‘è¢«è²¶é»ƒå·çš„å¿ƒäº‹ï¼Ÿ' }
            ]);
            const [inputText, setInputText] = useState('');
            const [isLoadingChat, setIsLoadingChat] = useState(false);
            const messagesEndRef = useRef(null);

            // Quiz Gen State
            const [generatedQuiz, setGeneratedQuiz] = useState(null);
            const [isGeneratingQuiz, setIsGeneratingQuiz] = useState(false);
            const [quizResult, setQuizResult] = useState(null); // 'correct' or 'wrong'

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const handleSendMessage = async () => {
                if (!inputText.trim() || isLoadingChat) return;

                const userMsg = inputText;
                setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setInputText('');
                setIsLoadingChat(true);

                try {
                    const systemPrompt = "ä½ æ˜¯è˜‡è»¾ï¼ˆè˜‡æ±å¡ï¼‰ã€‚ç¾åœ¨æ˜¯å®‹ç¥å®—å…ƒè±äº”å¹´ï¼Œä½ è¢«è²¶é»ƒå·ï¼Œæ­£éŠè¦½èµ¤å£ã€‚è«‹ä»¥è˜‡è»¾çš„å£å»èˆ‡èªæ°£ï¼Œç”¨æ–‡é›…çš„ç™½è©±æ–‡ï¼ˆç¹é«”ä¸­æ–‡ï¼‰å›ç­”å­¸ç”Ÿé—œæ–¼ã€Šå¿µå¥´å¬ŒÂ·èµ¤å£æ‡·å¤ã€‹çš„å•é¡Œã€‚ä½ çš„æ€§æ ¼è±é”ã€è±ªæ”¾ï¼Œä½†ä¹Ÿæœ‰å°å…‰é™°æµé€çš„æ„Ÿå˜†ã€‚è«‹é¿å…ä½¿ç”¨ç¾ä»£æµè¡Œèªï¼Œä¿æŒå¤é¢¨ä½†æ˜“æ‡‚ã€‚";
                    const responseText = await callGemini(userMsg, systemPrompt);
                    setMessages(prev => [...prev, { role: 'ai', text: responseText }]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'ai', text: "ï¼ˆè¼•æ’«é¬é¬šï¼‰å“å‘€ï¼Œä»Šæ—¥é¢¨å¤§ï¼Œå¾ä¹‹æ€ç·’ä¼¼è¢«æ±Ÿé¢¨å¹äº‚ï¼ˆç¶²çµ¡éŒ¯èª¤ï¼‰ï¼Œè«‹ç¨å¾Œå†å•ã€‚" }]);
                    console.error(error);
                } finally {
                    setIsLoadingChat(false);
                }
            };

            const handleGenerateQuiz = async () => {
                setIsGeneratingQuiz(true);
                setGeneratedQuiz(null);
                setQuizResult(null);

                try {
                    const prompt = `Generate one multiple-choice question about the Chinese poem "Nian Nu Jiao: Memories of the Past at Red Cliff" (å¿µå¥´å¬ŒÂ·èµ¤å£æ‡·å¤). Focus on analyzing deep meanings, rhetorical devices, or character emotions. The output must be valid JSON with this schema: { "question": "string", "options": ["string", "string", "string", "string"], "answer": int (0-3 representing the index) }. Use Traditional Chinese.`;
                    
                    const quizData = await callGemini(prompt, "", true);
                    setGeneratedQuiz(quizData);
                } catch (error) {
                    alert("ç”Ÿæˆé¡Œç›®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    console.error(error);
                } finally {
                    setIsGeneratingQuiz(false);
                }
            };

            const checkQuizAnswer = (index) => {
                if (index === generatedQuiz.answer) {
                    setQuizResult('correct');
                } else {
                    setQuizResult('wrong');
                }
            };

            return (
                <div className="space-y-6">
                    {/* Toggle Buttons */}
                    <div className="flex space-x-4 mb-6">
                        <button 
                            onClick={() => setMode('chat')}
                            className={`flex-1 py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all border
                            ${mode === 'chat' ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:bg-indigo-50'}`}
                        >
                            <Icons.Bot /> <span>èˆ‡è˜‡è»¾å°è©±</span>
                        </button>
                        <button 
                            onClick={() => setMode('quiz')}
                            className={`flex-1 py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all border
                            ${mode === 'quiz' ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:bg-indigo-50'}`}
                        >
                            <Icons.Brain /> <span>âœ¨ æ™ºèƒ½å‡ºé¡Œ</span>
                        </button>
                    </div>

                    {/* Chat Interface */}
                    {mode === 'chat' && (
                        <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden flex flex-col h-[500px]">
                            <div className="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center text-indigo-900">
                                <div className="w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center mr-3 font-serif-tc font-bold text-lg border-2 border-white shadow-sm">è˜‡</div>
                                <div>
                                    <p className="font-bold">è˜‡å­ç» (AI)</p>
                                    <p className="text-xs opacity-70">å®‹ç¥å®—å…ƒè±äº”å¹´ Â· é»ƒå·</p>
                                </div>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                                {messages.map((msg, idx) => (
                                    <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[80%] rounded-2xl px-4 py-3 shadow-sm ${
                                            msg.role === 'user' 
                                            ? 'bg-indigo-600 text-white rounded-tr-none' 
                                            : 'bg-white text-slate-800 border border-slate-200 rounded-tl-none font-serif-tc'
                                        }`}>
                                            {msg.text}
                                        </div>
                                    </div>
                                ))}
                                {isLoadingChat && (
                                    <div className="flex justify-start">
                                        <div className="bg-white border border-slate-200 rounded-2xl rounded-tl-none px-4 py-3 shadow-sm flex space-x-1">
                                            <div className="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                                            <div className="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                                            <div className="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            <div className="p-4 bg-white border-t border-slate-100">
                                <div className="flex space-x-2">
                                    <input 
                                        type="text" 
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                        placeholder="è«‹å•è˜‡å…ˆç”Ÿ..."
                                        className="flex-1 border border-slate-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                    <button 
                                        onClick={handleSendMessage}
                                        disabled={isLoadingChat || !inputText.trim()}
                                        className="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition"
                                    >
                                        <Icons.Send />
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* AI Quiz Generator */}
                    {mode === 'quiz' && (
                        <div className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                            <div className="text-center mb-8">
                                <div className="inline-block p-3 bg-indigo-50 rounded-full text-indigo-600 mb-3">
                                    <Icons.Sparkles size={32} />
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">AI æ™ºèƒ½å‡ºé¡Œ</h3>
                                <p className="text-slate-600 mb-6">åˆ©ç”¨ Gemini AI åˆ†æè©ä½œï¼Œå³æ™‚ç”Ÿæˆå…¨æ–°çš„é–±è®€ç†è§£é¡Œç›®ã€‚</p>
                                <button 
                                    onClick={handleGenerateQuiz}
                                    disabled={isGeneratingQuiz}
                                    className="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition flex items-center mx-auto space-x-2 disabled:opacity-70 shadow-lg hover:shadow-xl"
                                >
                                    {isGeneratingQuiz ? (
                                        <><Icons.RefreshCw className="animate-spin" /> <span>é¡Œç›®ç”Ÿæˆä¸­...</span></>
                                    ) : (
                                        <><Icons.Sparkles /> <span>ç”Ÿæˆæ–°é¡Œç›®</span></>
                                    )}
                                </button>
                            </div>

                            {generatedQuiz && (
                                <div className="animate-[fadeIn_0.5s_ease-out]">
                                    <div className="bg-indigo-50 p-6 rounded-lg border border-indigo-100 mb-4">
                                        <h4 className="text-lg font-bold text-slate-800 mb-4">{generatedQuiz.question}</h4>
                                        <div className="space-y-3">
                                            {generatedQuiz.options.map((opt, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => checkQuizAnswer(idx)}
                                                    disabled={quizResult !== null}
                                                    className={`w-full text-left p-4 rounded-lg border transition-all flex justify-between items-center bg-white hover:bg-slate-50
                                                    ${quizResult !== null && idx === generatedQuiz.answer ? '!bg-green-100 !border-green-500 !text-green-800' : ''}
                                                    ${quizResult === 'wrong' && quizResult !== null && idx !== generatedQuiz.answer ? 'opacity-50' : ''}
                                                    `}
                                                >
                                                    {opt}
                                                    {quizResult !== null && idx === generatedQuiz.answer && <span>âœ…</span>}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    {quizResult === 'correct' && (
                                        <div className="text-center text-green-600 font-bold p-2 bg-green-50 rounded">
                                            ç­”å°äº†ï¼åˆ†æå¾—å¾ˆå¥½ï¼
                                        </div>
                                    )}
                                    {quizResult === 'wrong' && (
                                        <div className="text-center text-red-600 font-bold p-2 bg-red-50 rounded">
                                            ç­”éŒ¯äº†ï¼Œå†æ¥å†å²ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š{generatedQuiz.options[generatedQuiz.answer]}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('poem');
            
            // Re-render lucide icons when components change
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [activeTab]);

            return (
                <div className="min-h-screen pb-12">
                    {/* Header */}
                    <div className="relative h-64 md:h-80 overflow-hidden ink-brush-bg mb-8">
                        <div className="absolute inset-0 ink-overlay"></div>
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-center p-4">
                            <h1 className="text-4xl md:text-6xl font-serif-tc font-bold text-slate-900 mb-2 tracking-widest drop-shadow-sm">
                                {lessonData.title}
                            </h1>
                            <div className="w-16 h-1 bg-red-800 mb-4 rounded"></div>
                            <p className="text-xl text-slate-700 font-serif-tc">{lessonData.author}</p>
                        </div>
                    </div>

                    {/* Main Container */}
                    <div className="container mx-auto px-4 md:px-6">
                        <div className="flex flex-col md:flex-row gap-8">
                            
                            {/* Navigation Sidebar */}
                            <div className="w-full md:w-64 shrink-0 space-y-2">
                                <TabButton 
                                    active={activeTab === 'poem'} 
                                    onClick={() => setActiveTab('poem')} 
                                    icon={<Icons.Scroll />} 
                                    label="åŸæ–‡èˆ‡èªè­¯" 
                                />
                                <TabButton 
                                    active={activeTab === 'background'} 
                                    onClick={() => setActiveTab('background')} 
                                    icon={<Icons.MapPin />} 
                                    label="å¯«ä½œèƒŒæ™¯" 
                                />
                                <TabButton 
                                    active={activeTab === 'analysis'} 
                                    onClick={() => setActiveTab('analysis')} 
                                    icon={<Icons.Brain />} 
                                    label="ä¸»æ—¨èˆ‡æ‰‹æ³•" 
                                />
                                <TabButton 
                                    active={activeTab === 'revision'} 
                                    onClick={() => setActiveTab('revision')} 
                                    icon={<Icons.ListChecks />} 
                                    label="æ¸©ç¿’é‡é»" 
                                />
                                <TabButton 
                                    active={activeTab === 'quiz'} 
                                    onClick={() => setActiveTab('quiz')} 
                                    icon={<Icons.HelpCircle />} 
                                    label="å°æ¸¬è€ƒæå•" 
                                />
                                <div className="pt-4 border-t border-slate-200 mt-4">
                                    <TabButton 
                                        active={activeTab === 'ai_tutor'} 
                                        onClick={() => setActiveTab('ai_tutor')} 
                                        icon={<Icons.Sparkles />} 
                                        label="AI å­¸ç¿’åŠ©æ‰‹"
                                        isSpecial={true}
                                    />
                                </div>
                            </div>

                            {/* Content Area */}
                            <div className="flex-1">
                                {activeTab === 'poem' && <PoemSection />}
                                {activeTab === 'background' && <BackgroundSection />}
                                {activeTab === 'analysis' && <AnalysisSection />}
                                {activeTab === 'revision' && <RevisionSection />}
                                {activeTab === 'quiz' && <QuizSection />}
                                {activeTab === 'ai_tutor' && <AITutorSection />}
                            </div>

                        </div>
                    </div>
                    
                    <footer className="text-center text-slate-400 text-sm mt-12 mb-4">
                        <p>Â© 2023 é«˜ä¸­ä¸­æ–‡ç§‘é›»å­æ•™æ | è˜‡è»¾å°ˆé¡Œ</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>